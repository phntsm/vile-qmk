/* Copyright 2015-2021 Jack Humbert
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include QMK_KEYBOARD_H

/// S U P E R M E G A   A L T + T A B
bool is_alt_tab_active = false;
uint16_t alt_tab_timer = 0;

/// S U P E R M E G A   A L T + T A B // timer
void matrix_scan_user(void) {
    if (is_alt_tab_active) {
        if (timer_elapsed(alt_tab_timer) > 666) {
            unregister_code(KC_LALT);
            is_alt_tab_active = false;
        }
    }
}

/// L A Y E R S
enum preonic_layers {
  _BASE,
  _LOWER,
  _RAISE,
  _FN,
  _GAME,
  _I,
  _II,
  _III,
  _CFG
};

enum preonic_keycodes {
  BASE = SAFE_RANGE,
  LOWER,
  RAISE,
  FN,
  GAME,
  I,
  II,
  III,
  CFG
};

/// M A P S
const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {

/* BASE ∝
 *  -----------------------------------------------------------------------.
 * (  ∈ ))     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----------------------------------------------------------------------|
 * |     |     |     |     |           |                 |     |     |     |
 * `-----------------------------------------------------------------------'
 */
[_BASE] = LAYOUT_preonic_grid(
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______
),

/* LOWER ∝
 *  -----------------------------------------------------------------------.
 * (  ∈ ))     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * `-----------------------------------------------------------------------'
 */
[_LOWER] = LAYOUT_preonic_grid(
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______
),


/* RAISE ∝
 *  -----------------------------------------------------------------------.
 * (  ∈ ))     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * `-----------------------------------------------------------------------'
 */
[_RAISE] = LAYOUT_preonic_grid(
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______
),

/* FN ∝
 *  -----------------------------------------------------------------------.
 * (  ∈ ))     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * `-----------------------------------------------------------------------'
 */
[_FN] = LAYOUT_preonic_grid(
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______
),

/* GAME ∝
 *  -----------------------------------------------------------------------.
 * (  G  )     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * `-----------------------------------------------------------------------'
 */
[_GAME] = LAYOUT_preonic_grid(
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______
),


/* I ∝
 *  -----------------------------------------------------------------------.
 * (  ∈ ))     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * `-----------------------------------------------------------------------'
 */
[_I] = LAYOUT_preonic_grid(
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______
),
/* II ∝
 *  -----------------------------------------------------------------------.
 * (  ∈ ))     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * `-----------------------------------------------------------------------'
 */
[_II] = LAYOUT_preonic_grid(
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______
),

/* III ∝
 *  -----------------------------------------------------------------------.
 * (  ∈ ))     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * `-----------------------------------------------------------------------'
 */
[_III] = LAYOUT_preonic_grid(
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______
),

/* CFG ∝
 *  -----------------------------------------------------------------------.
 * (  ∈ ))     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * |-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
 * |     |     |     |     |     |     |     |     |     |     |     |     |
 * `-----------------------------------------------------------------------'
 */
[_CFG] = LAYOUT_preonic_grid(
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______
),

};

/// E N C O D E R
bool encoder_update_user(uint8_t index, bool clockwise) {
    if (get_highest_layer(layer_state|default_layer_state) == 0) {

            if (clockwise) {
                tap_code(KC_VOLU);
            } else {
                tap_code(KC_VOLD);
            }
    } else if (get_highest_layer(layer_state|default_layer_state) == 1) {  /* Layer 1 */
            register_code(KC_LALT);
            is_alt_tab_active = true;
            if (clockwise) {
                tap_code(KC_TAB);
            } else {
                register_code(KC_LSFT);
                tap_code(KC_TAB);
                unregister_code(KC_LSFT);
            }
            alt_tab_timer = timer_read();
    }
    return false;
};
